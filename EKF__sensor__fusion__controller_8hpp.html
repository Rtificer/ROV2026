<!-- HTML header for doxygen 1.9.8-->
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=11" />
  <meta name="generator" content="Doxygen 1.9.8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ROV2026: src/rov_control/include/rov_control/EKF_sensor_fusion_controller.hpp File Reference</title>
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <script type="text/javascript" src="darkmode_toggle.js"></script>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript">
    // Force dark mode as default if no preference is set
    if (window.matchMedia && !localStorage.getItem('doxygen-awesome-dark-mode')) {
      if (!window.matchMedia('(prefers-color-scheme: dark)').matches) {
        localStorage.setItem('doxygen-awesome-dark-mode', 'dark');
      }
    }
  </script>
  <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
  <script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
  </script>
</head>
<body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
      <div id="titlearea">
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr id="projectrow">
              <td id="projectalign">
                <div id="projectname">ROV2026
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- end header part --><!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('EKF__sensor__fusion__controller_8hpp.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">EKF_sensor_fusion_controller.hpp File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Extended Kalman Filter for 6-DOF State Estimation with IMU, Pressure Sensor, and USBL.  
<a href="#details">More...</a></p>

<p><a href="EKF__sensor__fusion__controller_8hpp_source.html">Go to the source code of this file.</a></p>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Extended Kalman Filter for 6-DOF State Estimation with IMU, Pressure Sensor, and USBL. </p>
<p>This filter estimates the full 6-DOF state of a vehicle by fusing data from:</p><ul>
<li>A 9-DOF IMU (e.g., BNO055) providing linear acceleration, angular velocity, and orientation (quaternion).</li>
<li>A pressure sensor providing depth (z-position).</li>
<li>A USBL system providing noisy position fixes, with distance-dependent measurement uncertainty.</li>
</ul>
<h1><a class="anchor" id="state_vector"></a>
State Definition</h1>
<p>The EKF state vector is:  </p><p class="formulaDsp">
<img class="formulaDsp light-mode-visible" alt="\[
\mathbf{x}_k =
\begin{bmatrix}
\mathbf{p}_k \\
\mathbf{v}_k \\
\mathbf{q}_k \\
\boldsymbol{\omega}_k
\end{bmatrix}
\in \mathbb{R}^{13}
\]" src="form_0.png"/><img class="formulaDsp dark-mode-visible" alt="\[
\mathbf{x}_k =
\begin{bmatrix}
\mathbf{p}_k \\
\mathbf{v}_k \\
\mathbf{q}_k \\
\boldsymbol{\omega}_k
\end{bmatrix}
\in \mathbb{R}^{13}
\]" src="form_0_dark.png"/>
</p>
<p>where:</p><ul>
<li><img class="formulaInl light-mode-visible" alt="$ \mathbf{p}_k \in \mathbb{R}^3 $" src="form_1.png"/><img class="formulaInl dark-mode-visible" alt="$ \mathbf{p}_k \in \mathbb{R}^3 $" src="form_1_dark.png"/>: Position in the world frame.</li>
<li><img class="formulaInl light-mode-visible" alt="$ \mathbf{v}_k \in \mathbb{R}^3 $" src="form_2.png"/><img class="formulaInl dark-mode-visible" alt="$ \mathbf{v}_k \in \mathbb{R}^3 $" src="form_2_dark.png"/>: Velocity in the world frame.</li>
<li><img class="formulaInl light-mode-visible" alt="$ \mathbf{q}_k \in \mathbb{R}^4 $" src="form_3.png"/><img class="formulaInl dark-mode-visible" alt="$ \mathbf{q}_k \in \mathbb{R}^4 $" src="form_3_dark.png"/>: Unit quaternion (orientation from body to world frame).</li>
<li><img class="formulaInl light-mode-visible" alt="$ \boldsymbol{\omega}_k \in \mathbb{R}^3 $" src="form_4.png"/><img class="formulaInl dark-mode-visible" alt="$ \boldsymbol{\omega}_k \in \mathbb{R}^3 $" src="form_4_dark.png"/>: Angular velocity in the body frame.</li>
</ul>
<h1><a class="anchor" id="process_model"></a>
Process Model</h1>
<p>The discrete-time motion model over timestep <img class="formulaInl light-mode-visible" alt="$ \Delta t $" src="form_5.png"/><img class="formulaInl dark-mode-visible" alt="$ \Delta t $" src="form_5_dark.png"/> is:</p>
<p class="formulaDsp">
<img class="formulaDsp light-mode-visible" alt="\[
\begin{aligned}
\mathbf{p}_{k+1} &amp;= \mathbf{p}_k + \mathbf{v}_k \Delta t + \frac{1}{2}(\mathbf{R}(\mathbf{q}_k)\mathbf{a}_k - \mathbf{g}) \Delta t^2 \\
\mathbf{v}_{k+1} &amp;= \mathbf{v}_k + (\mathbf{R}(\mathbf{q}_k)\mathbf{a}_k - \mathbf{g}) \Delta t \\
\mathbf{q}_{k+1} &amp;= \mathbf{q}_k \otimes \exp_q\left( \frac{1}{2} \boldsymbol{\omega}_k \Delta t \right) \\
\boldsymbol{\omega}_{k+1} &amp;= \boldsymbol{\omega}_k
\end{aligned}
\]" src="form_6.png"/><img class="formulaDsp dark-mode-visible" alt="\[
\begin{aligned}
\mathbf{p}_{k+1} &amp;= \mathbf{p}_k + \mathbf{v}_k \Delta t + \frac{1}{2}(\mathbf{R}(\mathbf{q}_k)\mathbf{a}_k - \mathbf{g}) \Delta t^2 \\
\mathbf{v}_{k+1} &amp;= \mathbf{v}_k + (\mathbf{R}(\mathbf{q}_k)\mathbf{a}_k - \mathbf{g}) \Delta t \\
\mathbf{q}_{k+1} &amp;= \mathbf{q}_k \otimes \exp_q\left( \frac{1}{2} \boldsymbol{\omega}_k \Delta t \right) \\
\boldsymbol{\omega}_{k+1} &amp;= \boldsymbol{\omega}_k
\end{aligned}
\]" src="form_6_dark.png"/>
</p>
<p>where:</p><ul>
<li><img class="formulaInl light-mode-visible" alt="$ \mathbf{a}_k $" src="form_7.png"/><img class="formulaInl dark-mode-visible" alt="$ \mathbf{a}_k $" src="form_7_dark.png"/>: IMU-measured linear acceleration (body frame).</li>
<li><img class="formulaInl light-mode-visible" alt="$ \mathbf{R}(\mathbf{q}) $" src="form_8.png"/><img class="formulaInl dark-mode-visible" alt="$ \mathbf{R}(\mathbf{q}) $" src="form_8_dark.png"/>: Rotation matrix corresponding to <img class="formulaInl light-mode-visible" alt="$ \mathbf{q} $" src="form_9.png"/><img class="formulaInl dark-mode-visible" alt="$ \mathbf{q} $" src="form_9_dark.png"/>.</li>
<li><img class="formulaInl light-mode-visible" alt="$ \exp_q(\cdot) $" src="form_10.png"/><img class="formulaInl dark-mode-visible" alt="$ \exp_q(\cdot) $" src="form_10_dark.png"/>: Quaternion exponential map.</li>
<li><img class="formulaInl light-mode-visible" alt="$ \mathbf{g} $" src="form_11.png"/><img class="formulaInl dark-mode-visible" alt="$ \mathbf{g} $" src="form_11_dark.png"/>: World-frame gravity vector.</li>
<li><img class="formulaInl light-mode-visible" alt="$ \otimes $" src="form_12.png"/><img class="formulaInl dark-mode-visible" alt="$ \otimes $" src="form_12_dark.png"/>: Quaternion multiplication.</li>
</ul>
<h1><a class="anchor" id="quaternion_expmap"></a>
Quaternion Exponential Map</h1>
<p>Used to update orientation from angular velocity:  </p><p class="formulaDsp">
<img class="formulaDsp light-mode-visible" alt="\[
\delta \mathbf{q}_k = \exp_q\left( \frac{1}{2} \boldsymbol{\omega}_k \Delta t \right)
= \left[ \cos\left(\frac{\theta}{2}\right),\ \sin\left(\frac{\theta}{2}\right) \frac{\boldsymbol{\omega}_k}{\theta} \right]
\quad \text{where} \quad \theta = \|\boldsymbol{\omega}_k\| \Delta t
\]" src="form_13.png"/><img class="formulaDsp dark-mode-visible" alt="\[
\delta \mathbf{q}_k = \exp_q\left( \frac{1}{2} \boldsymbol{\omega}_k \Delta t \right)
= \left[ \cos\left(\frac{\theta}{2}\right),\ \sin\left(\frac{\theta}{2}\right) \frac{\boldsymbol{\omega}_k}{\theta} \right]
\quad \text{where} \quad \theta = \|\boldsymbol{\omega}_k\| \Delta t
\]" src="form_13_dark.png"/>
</p>
<p>For small <img class="formulaInl light-mode-visible" alt="$ \theta $" src="form_14.png"/><img class="formulaInl dark-mode-visible" alt="$ \theta $" src="form_14_dark.png"/>, use first-order approximation: <img class="formulaInl light-mode-visible" alt="$ \delta \mathbf{q}_k \approx [1,\ \frac{1}{2} \boldsymbol{\omega}_k \Delta t] $" src="form_15.png"/><img class="formulaInl dark-mode-visible" alt="$ \delta \mathbf{q}_k \approx [1,\ \frac{1}{2} \boldsymbol{\omega}_k \Delta t] $" src="form_15_dark.png"/></p>
<h1><a class="anchor" id="measurement_models"></a>
Measurement Models</h1>
<ul>
<li><b>Pressure Sensor (depth only):</b> <img class="formulaInl light-mode-visible" alt="$ z_k = p_k^{(z)} + v_k $" src="form_16.png"/><img class="formulaInl dark-mode-visible" alt="$ z_k = p_k^{(z)} + v_k $" src="form_16_dark.png"/></li>
<li><b>USBL Position Measurement:</b>  <p class="formulaDsp">
<img class="formulaDsp light-mode-visible" alt="\[
  \mathbf{z}_k^{\text{USBL}} = \mathbf{p}_k + \mathbf{v}_k^{\text{noise}}
  \]" src="form_17.png"/><img class="formulaDsp dark-mode-visible" alt="\[
  \mathbf{z}_k^{\text{USBL}} = \mathbf{p}_k + \mathbf{v}_k^{\text{noise}}
  \]" src="form_17_dark.png"/>
</p>
</li>
</ul>
<h1><a class="anchor" id="usb_cov"></a>
USBL Position Measurement Model and Range-Dependent Noise Covariance</h1>
<p>The USBL (Ultra-Short Baseline) system provides an indirect position fix.</p>
<h2><a class="anchor" id="range_dependent_cov"></a>
Range-Dependent Measurement Noise Covariance</h2>
<p>Due to the USBL's reliance on angle-of-arrival sensing, measurement error increases with range. A small angular error <img class="formulaInl light-mode-visible" alt="$ \delta\theta $" src="form_18.png"/><img class="formulaInl dark-mode-visible" alt="$ \delta\theta $" src="form_18_dark.png"/> corresponds to larger position uncertainty at greater distances.</p>
<h2><a class="anchor" id="geometric_interp"></a>
Geometric Interpretation</h2>
<p>The vehicle's true position lies on a sphere of radius <img class="formulaInl light-mode-visible" alt="$ r_k = \|p_k - p_{USBL}\| $" src="form_19.png"/><img class="formulaInl dark-mode-visible" alt="$ r_k = \|p_k - p_{USBL}\| $" src="form_19_dark.png"/>. Angular error introduces tangent-plane uncertainty; range error affects the radial direction.</p>
<h2><a class="anchor" id="covariance_model"></a>
Covariance Modeling</h2>
<p>The USBL measurement noise covariance matrix is modeled as:</p>
<p class="formulaDsp">
<img class="formulaDsp light-mode-visible" alt="\[
R_k^{\text{USBL}} = \sigma_\theta^2 r_k^2 (I_3 - \mathbf{n}\mathbf{n}^T) + \sigma_r^2 \mathbf{n}\mathbf{n}^T
\]" src="form_20.png"/><img class="formulaDsp dark-mode-visible" alt="\[
R_k^{\text{USBL}} = \sigma_\theta^2 r_k^2 (I_3 - \mathbf{n}\mathbf{n}^T) + \sigma_r^2 \mathbf{n}\mathbf{n}^T
\]" src="form_20_dark.png"/>
</p>
<p>where:</p><ul>
<li><img class="formulaInl light-mode-visible" alt="$ \sigma_\theta^2 $" src="form_21.png"/><img class="formulaInl dark-mode-visible" alt="$ \sigma_\theta^2 $" src="form_21_dark.png"/>: Angle-of-arrival variance.</li>
<li><img class="formulaInl light-mode-visible" alt="$ \sigma_r^2 $" src="form_22.png"/><img class="formulaInl dark-mode-visible" alt="$ \sigma_r^2 $" src="form_22_dark.png"/>: Range measurement variance.</li>
<li><img class="formulaInl light-mode-visible" alt="$ \mathbf{n} = \frac{\mathbf{p}_k - \mathbf{p}_{USBL}}{\|\mathbf{p}_k - \mathbf{p}_{USBL}\|} $" src="form_23.png"/><img class="formulaInl dark-mode-visible" alt="$ \mathbf{n} = \frac{\mathbf{p}_k - \mathbf{p}_{USBL}}{\|\mathbf{p}_k - \mathbf{p}_{USBL}\|} $" src="form_23_dark.png"/>: Line-of-sight unit vector.</li>
<li><img class="formulaInl light-mode-visible" alt="$ I_3 - \mathbf{n}\mathbf{n}^T $" src="form_24.png"/><img class="formulaInl dark-mode-visible" alt="$ I_3 - \mathbf{n}\mathbf{n}^T $" src="form_24_dark.png"/>: Projects onto the tangent plane of the measurement sphere.</li>
</ul>
<h2><a class="anchor" id="covariance_intuition"></a>
Intuition</h2>
<ul>
<li><img class="formulaInl light-mode-visible" alt="$ \sigma_\theta^2 r_k^2 (I - nn^T) $" src="form_25.png"/><img class="formulaInl dark-mode-visible" alt="$ \sigma_\theta^2 r_k^2 (I - nn^T) $" src="form_25_dark.png"/> captures angular uncertainty (perpendicular).</li>
<li><img class="formulaInl light-mode-visible" alt="$ \sigma_r^2 nn^T $" src="form_26.png"/><img class="formulaInl dark-mode-visible" alt="$ \sigma_r^2 nn^T $" src="form_26_dark.png"/> captures radial uncertainty (along line-of-sight).</li>
</ul>
<p>This results in an ellipsoidal measurement covariance aligned with the sensor geometry.</p>
<h1><a class="anchor" id="ekf_update"></a>
EKF Measurement Update</h1>
<p>During each EKF update:</p><ul>
<li>The range <img class="formulaInl light-mode-visible" alt="$ r_k $" src="form_27.png"/><img class="formulaInl dark-mode-visible" alt="$ r_k $" src="form_27_dark.png"/> is recomputed from the predicted state.</li>
<li>The USBL measurement covariance <img class="formulaInl light-mode-visible" alt="$ R_k^{USBL} $" src="form_28.png"/><img class="formulaInl dark-mode-visible" alt="$ R_k^{USBL} $" src="form_28_dark.png"/> is recalculated.</li>
<li>Measurement Jacobians <img class="formulaInl light-mode-visible" alt="$ H_k $" src="form_29.png"/><img class="formulaInl dark-mode-visible" alt="$ H_k $" src="form_29_dark.png"/> are constructed for:<ul>
<li>USBL: <img class="formulaInl light-mode-visible" alt="$ H_k^{USBL} = [I_3,\ 0_{3x10}] $" src="form_30.png"/><img class="formulaInl dark-mode-visible" alt="$ H_k^{USBL} = [I_3,\ 0_{3x10}] $" src="form_30_dark.png"/></li>
<li>Pressure: <img class="formulaInl light-mode-visible" alt="$ H_k^{depth} = [0\ 0\ 1\ \mathbf{0}_{1 \times 10}] $" src="form_31.png"/><img class="formulaInl dark-mode-visible" alt="$ H_k^{depth} = [0\ 0\ 1\ \mathbf{0}_{1 \times 10}] $" src="form_31_dark.png"/></li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="jacobians"></a>
Jacobian Computation</h1>
<p>The EKF linearizes the process and measurement models:</p><ul>
<li>State transition Jacobian <img class="formulaInl light-mode-visible" alt="$ F_k = \frac{\partial f}{\partial x} $" src="form_32.png"/><img class="formulaInl dark-mode-visible" alt="$ F_k = \frac{\partial f}{\partial x} $" src="form_32_dark.png"/></li>
<li>Measurement Jacobian <img class="formulaInl light-mode-visible" alt="$ H_k = \frac{\partial h}{\partial x} $" src="form_33.png"/><img class="formulaInl dark-mode-visible" alt="$ H_k = \frac{\partial h}{\partial x} $" src="form_33_dark.png"/></li>
</ul>
<p>Orientation derivatives use quaternion product Jacobians:</p>
<p>Left quaternion multiplication matrix:  </p><p class="formulaDsp">
<img class="formulaDsp light-mode-visible" alt="\[
L(\mathbf{q}) =
\begin{bmatrix}
q_w &amp; -q_x &amp; -q_y &amp; -q_z \\
q_x &amp;  q_w &amp; -q_z &amp;  q_y \\
q_y &amp;  q_z &amp;  q_w &amp; -q_x \\
q_z &amp; -q_y &amp;  q_x &amp;  q_w
\end{bmatrix}
\]" src="form_34.png"/><img class="formulaDsp dark-mode-visible" alt="\[
L(\mathbf{q}) =
\begin{bmatrix}
q_w &amp; -q_x &amp; -q_y &amp; -q_z \\
q_x &amp;  q_w &amp; -q_z &amp;  q_y \\
q_y &amp;  q_z &amp;  q_w &amp; -q_x \\
q_z &amp; -q_y &amp;  q_x &amp;  q_w
\end{bmatrix}
\]" src="form_34_dark.png"/>
</p>
<p>And the derivative of rotated vectors:  </p><p class="formulaDsp">
<img class="formulaDsp light-mode-visible" alt="\[
\frac{\partial (\mathbf{R}(\mathbf{q}) \mathbf{a})}{\partial \mathbf{q}} \in \mathbb{R}^{3 \times 4}
\]" src="form_35.png"/><img class="formulaDsp dark-mode-visible" alt="\[
\frac{\partial (\mathbf{R}(\mathbf{q}) \mathbf{a})}{\partial \mathbf{q}} \in \mathbb{R}^{3 \times 4}
\]" src="form_35_dark.png"/>
</p>
<p> gives sensitivity of the rotated IMU accelerations to orientation changes.</p>
<p>These Jacobians are essential for accurately propagating uncertainty in nonlinear systems. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_4d9e6af0123971837824dfe4e67503a9.html">rov_control</a></li><li class="navelem"><a class="el" href="dir_d529950bd809127c82dd21a158f9c8ee.html">include</a></li><li class="navelem"><a class="el" href="dir_1221e203e50e6cd6e1d25f90da979ab2.html">rov_control</a></li><li class="navelem"><a class="el" href="EKF__sensor__fusion__controller_8hpp.html">EKF_sensor_fusion_controller.hpp</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
