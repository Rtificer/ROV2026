<!-- HTML header for doxygen 1.9.8-->
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=11" />
  <meta name="generator" content="Doxygen 1.9.8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ROV2026: src/rov_control/include/rov_control/EKF_sensor_fusion_controller.hpp File Reference</title>
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  <script type="text/javascript" src="darkmode_toggle.js"></script>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript">
    // Force dark mode as default if no preference is set
    if (window.matchMedia && !localStorage.getItem('doxygen-awesome-dark-mode')) {
      if (!window.matchMedia('(prefers-color-scheme: dark)').matches) {
        localStorage.setItem('doxygen-awesome-dark-mode', 'dark');
      }
    }
  </script>
  <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
  <script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
  </script>
</head>
<body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
      <div id="titlearea">
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr id="projectrow">
              <td id="projectalign">
                <div id="projectname">ROV2026
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- end header part --><!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('EKF__sensor__fusion__controller_8hpp.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">EKF_sensor_fusion_controller.hpp File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Extended Kalman Filter for 6-DOF State Estimation with IMU, Pressure Sensor, and USBL.  
<a href="#details">More...</a></p>

<p><a href="EKF__sensor__fusion__controller_8hpp_source.html">Go to the source code of this file.</a></p>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Extended Kalman Filter for 6-DOF State Estimation with IMU, Pressure Sensor, and USBL. </p>
<p>This filter estimates the full 6-DOF state of a vehicle by fusing data from:</p><ul>
<li>A 9-DOF IMU (e.g., BNO055) providing linear acceleration, angular velocity, and orientation (quaternion).</li>
<li>A pressure sensor providing depth (z-position).</li>
<li>A USBL system providing noisy position fixes, with distance-dependent measurement uncertainty.</li>
</ul>
<h1><a class="anchor" id="state_vector"></a>
State Definition</h1>
<p>The EKF state vector is:  </p><p class="formulaDsp">
\[
\mathbf{x}_k =
\begin{bmatrix}
\mathbf{p}_k \\
\mathbf{v}_k \\
\mathbf{q}_k \\
\boldsymbol{\omega}_k \\
\mathbf{b}_{\boldsymbol{\omega}_k} \\
\mathbf{b}_{\mathbf{a}_k}
\end{bmatrix}
\in \mathbb{R}^{19}
\]
</p>
<p>where:</p><ul>
<li>\( \mathbf{p}_k \in \mathbb{R}^3 \): Position in the world frame.</li>
<li>\( \mathbf{v}_k \in \mathbb{R}^3 \): Velocity in the world frame.</li>
<li>\( \mathbf{q}_k \in \mathbb{R}^4 \): Unit quaternion (orientation from body to world frame).</li>
<li>\( \boldsymbol{\omega}_k \in \mathbb{R}^3 \): Angular velocity in the body frame.</li>
<li>\( \mathbf{b}_{\boldsymbol{\omega}_k} \in \mathbb{R}^3 \): Gyro bias.</li>
<li>\( \mathbf{b}_{\mathbf{a}_k} \in \mathbb{R}^3 \): Accelerometer bias.</li>
</ul>
<h1><a class="anchor" id="process_model"></a>
Process Model</h1>
<p>The discrete-time motion model over timestep \( \Delta t \) is:</p>
<p class="formulaDsp">
\[
\begin{aligned}
\mathbf{p}_{k+1} &amp;= \mathbf{p}_k + \mathbf{v}_k \Delta t + \frac{1}{2}(\mathbf{R}(\mathbf{q}_k)(\mathbf{a}_k-\mathbf{b}_{\mathbf{a}_k}) - \mathbf{g}) \Delta t^2 \\
\mathbf{v}_{k+1} &amp;= \mathbf{v}_k + (\mathbf{R}(\mathbf{q}_k)(\mathbf{a}_k-\mathbf{b}_{\mathbf{a}_k}) - \mathbf{g}) \Delta t - \mathbf{D}_{\text{linear}}\mathbf{v}_k\Delta t \\
\mathbf{q}_{k+1} &amp;= \mathbf{q}_k \otimes \exp_q\left( \frac{1}{2} (\boldsymbol{\omega}_k-\mathbf{b}_{\boldsymbol{\omega}_k}) \Delta t \right) \\
\boldsymbol{\omega}_{k+1} &amp;= \boldsymbol{\omega}_k - \mathbf{D}_{\text{angular}}\boldsymbol{\omega}_k\Delta t + \mathbf{w}_{\boldsymbol{\omega}} \\
\mathbf{b}_{\boldsymbol{\omega}_{k+1}} &amp;= \mathbf{b}_{\boldsymbol{\omega}_k} + \mathbf{w}_b \\
\mathbf{b}_{\mathbf{a}_{k+1}} &amp;= \mathbf{b}_{\mathbf{a}_k} + \mathbf{w}_{ba}
\end{aligned}
\]
</p>
<p>where:</p><ul>
<li>\( \mathbf{a}_k \): IMU-measured linear acceleration (body frame).</li>
<li>\( \mathbf{R}(\mathbf{q}) \): Rotation matrix corresponding to \( \mathbf{q} \).</li>
<li>\( \exp_q(\cdot) \): Quaternion exponential map.</li>
<li>\( \mathbf{g} \): World-frame gravity vector.</li>
<li>\( \otimes \): Quaternion multiplication.</li>
<li>\( \mathbf{w}_{\boldsymbol{\omega}} \): Angular velocity random walk noise.</li>
<li>\( \mathbf{w}_b \): Gyro bias random walk noise.</li>
<li>\( \mathbf{w}_{ba} \): Accelerometer bias random walk noise.</li>
<li>\( \mathbf{D}_{\text{linear}} = \text{diag}(d_x, d_y, d_z) \): Linear drag coefficients.</li>
<li>\( \mathbf{D}_{\text{angular}} = \text{diag}(d_{\text{roll}}, d_{\text{pitch}}, d_{\text{yaw}}) \): Angular drag coefficients.</li>
</ul>
<h1><a class="anchor" id="hydrodynamic_model"></a>
Hydrodynamic Effects Model</h1>
<p>The filter incorporates a simplified hydrodynamic model to account for drag forces in underwater environments:</p>
<p class="formulaDsp">
\[
\begin{aligned}
\mathbf{F}_{\text{drag}} &amp;= -\mathbf{D}_{\text{linear}}\mathbf{v}_k \\
\boldsymbol{\tau}_{\text{drag}} &amp;= -\mathbf{D}_{\text{angular}}\boldsymbol{\omega}_k
\end{aligned}
\]
</p>
<p>where:</p><ul>
<li>\( \mathbf{F}_{\text{drag}} \): Drag force in world frame.</li>
<li>\( \boldsymbol{\tau}_{\text{drag}} \): Drag torque in body frame.</li>
<li>\( \mathbf{D}_{\text{linear}} \) and \( \mathbf{D}_{\text{angular}} \): Diagonal matrices of linear and angular drag coefficients.</li>
</ul>
<p>This model captures the first-order effects of water resistance, which is particularly important for accurate velocity estimation and improved dead-reckoning performance during periods without external position measurements.</p>
<h1><a class="anchor" id="quaternion_expmap"></a>
Quaternion Exponential Map</h1>
<p>Used to update orientation from angular velocity:  </p><p class="formulaDsp">
\[
\delta \mathbf{q}_k = \exp_q\left( \frac{1}{2} \boldsymbol{\omega}_k \Delta t \right)
= \left[ \cos\left(\frac{\theta}{2}\right),\ \sin\left(\frac{\theta}{2}\right) \frac{\boldsymbol{\omega}_k}{\theta} \right]
\quad \text{where} \quad \theta = \|\boldsymbol{\omega}_k\| \Delta t
\]
</p>
<p>For small \( \theta \), use first-order approximation: \( \delta \mathbf{q}_k \approx [1,\ \frac{1}{2} \boldsymbol{\omega}_k \Delta t] \)</p>
<h1><a class="anchor" id="measurement_models"></a>
Measurement Models</h1>
<ul>
<li><b>Pressure Sensor (depth only):</b> \( z_k = p_k^{(z)} + v_k \)</li>
<li><b>USBL Position Measurement:</b> \( z_k^{\text{USBL}} = p_k + v_k^{\text{noise}} \)</li>
</ul>
<h1><a class="anchor" id="measurement_gating"></a>
Measurement Validation Gating</h1>
<p>A statistical validation gate is applied to reject outlier measurements: <a href="https://rtificer.github.io/ROV2026/EKF__sensor__fusion__controller_8hpp.html">https://rtificer.github.io/ROV2026/EKF__sensor__fusion__controller_8hpp.html</a>  </p><p class="formulaDsp">
\[
d^2 = \mathbf{y}_k^T \mathbf{S}_k^{-1} \mathbf{y}_k \leq \gamma
\]
</p>
<p>where:</p><ul>
<li>\( \mathbf{y}_k = \mathbf{z}_k - h(\mathbf{x}_{k|k-1}) \) is the innovation (measurement residual)</li>
<li>\( \mathbf{S}_k = \mathbf{H}_k \mathbf{P}_{k|k-1} \mathbf{H}_k^T + \mathbf{R}_k \) is the innovation covariance</li>
<li>\( d^2 \) is the squared Mahalanobis distance</li>
<li>\( \gamma \) is the chi-square threshold for the given confidence level and measurement dimension</li>
</ul>
<p>Measurements that fail this test are considered outliers and are not used in the update step. This is especially important for USBL measurements, which can occasionally suffer from multipath effects, interference, or other anomalies that lead to highly erroneous position fixes.</p>
<h1><a class="anchor" id="usb_cov"></a>
USBL Position Measurement Model and Range-Dependent Noise Covariance</h1>
<p>The USBL (Ultra-Short Baseline) system provides an indirect position fix.</p>
<h2><a class="anchor" id="range_dependent_cov"></a>
Range-Dependent Measurement Noise Covariance</h2>
<p>Due to the USBL's reliance on angle-of-arrival sensing, measurement error increases with range. A small angular error \( \delta\theta \) corresponds to larger position uncertainty at greater distances.</p>
<h2><a class="anchor" id="geometric_interp"></a>
Geometric Interpretation</h2>
<p>The vehicle's true position lies on a sphere of radius \( r_k = \|p_k - p_{USBL}\| \). Angular error introduces tangent-plane uncertainty; range error affects the radial direction.</p>
<h2><a class="anchor" id="covariance_model"></a>
Covariance Modeling</h2>
<p>The USBL measurement noise covariance matrix is modeled as:</p>
<p class="formulaDsp">
\[
R_k^{\text{USBL}} = \sigma_\theta^2 r_k^2 (I_3 - \mathbf{n}\mathbf{n}^T) + \sigma_r^2 \mathbf{n}\mathbf{n}^T
\]
</p>
<p>where:</p><ul>
<li>\( \sigma_\theta^2 \): Angle-of-arrival variance.</li>
<li>\( \sigma_r^2 \): Range measurement variance.</li>
<li>\( \mathbf{n} = \frac{\mathbf{p}_k - \mathbf{p}_{USBL}}{\|\mathbf{p}_k - \mathbf{p}_{USBL}\|} \): Line-of-sight unit vector.</li>
<li>\( I_3 - \mathbf{n}\mathbf{n}^T \): Projects onto the tangent plane of the measurement sphere.</li>
</ul>
<h2><a class="anchor" id="covariance_intuition"></a>
Intuition</h2>
<ul>
<li>\( \sigma_\theta^2 r_k^2 (I - nn^T) \) captures angular uncertainty (perpendicular).</li>
<li>\( \sigma_r^2 nn^T \) captures radial uncertainty (along line-of-sight).</li>
</ul>
<p>This results in an ellipsoidal measurement covariance aligned with the sensor geometry.</p>
<h1><a class="anchor" id="accelerometer_bias"></a>
Accelerometer Bias Estimation</h1>
<p>The filter estimates accelerometer bias \( \mathbf{b}_{\mathbf{a}} \) to compensate for systematic errors:</p>
<p class="formulaDsp">
\[
\begin{aligned}
\mathbf{a}_{\text{true}} &amp;= \mathbf{a}_{\text{measured}} - \mathbf{b}_{\mathbf{a}} \\
\mathbf{b}_{\mathbf{a}_{k+1}} &amp;= \mathbf{b}_{\mathbf{a}_k} + \mathbf{w}_{ba}
\end{aligned}
\]
</p>
<p>where \( \mathbf{w}_{ba} \sim \mathcal{N}(0, \mathbf{Q}_{ba}) \) models the bias as a random walk process.</p>
<p>Bias estimation is critical because:</p><ul>
<li>Small biases integrate into significant velocity errors over time</li>
<li>They distinguish true accelerations from sensor offsets</li>
<li>They compensate for temperature-dependent drift and manufacturing imperfections</li>
</ul>
<p>Since accelerometer biases couple with gravity in the world frame, they're best observable during maneuvers with varying orientation relative to gravity.</p>
<h1><a class="anchor" id="ekf_update"></a>
EKF Measurement Update</h1>
<p>During each EKF update:</p><ul>
<li>The range \( r_k \) is recomputed from the predicted state.</li>
<li>The USBL measurement covariance \( R_k^{USBL} \) is recalculated.</li>
<li>Measurement Jacobians \( H_k \) are constructed for:<ul>
<li>USBL: \( H_k^{USBL} = [I_3,\ 0_{3x16}] \)</li>
<li>Pressure: \( H_k^{depth} = [0\ 0\ 1\ \mathbf{0}_{1 \times 16}] \)</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="jacobians"></a>
Jacobian Computation</h1>
<p>The EKF linearizes the process and measurement models:</p><ul>
<li>State transition Jacobian \( F_k = \frac{\partial f}{\partial x} \)</li>
<li>Measurement Jacobian \( H_k = \frac{\partial h}{\partial x} \)</li>
</ul>
<p>Orientation derivatives use quaternion product Jacobians:</p>
<p>Left quaternion multiplication matrix:  </p><p class="formulaDsp">
\[
L(\mathbf{q}) =
\begin{bmatrix}
q_w &amp; -q_x &amp; -q_y &amp; -q_z \\
q_x &amp;  q_w &amp; -q_z &amp;  q_y \\
q_y &amp;  q_z &amp;  q_w &amp; -q_x \\
q_z &amp; -q_y &amp;  q_x &amp;  q_w
\end{bmatrix}
\]
</p>
<p>And the derivative of rotated vectors:  </p><p class="formulaDsp">
\[
\frac{\partial (\mathbf{R}(\mathbf{q}) \mathbf{a})}{\partial \mathbf{q}} \in \mathbb{R}^{3 \times 4}
\]
</p>
<p> gives sensitivity of the rotated IMU accelerations to orientation changes.</p>
<p>These Jacobians are essential for accurately propagating uncertainty in nonlinear systems. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_4d9e6af0123971837824dfe4e67503a9.html">rov_control</a></li><li class="navelem"><a class="el" href="dir_d529950bd809127c82dd21a158f9c8ee.html">include</a></li><li class="navelem"><a class="el" href="dir_1221e203e50e6cd6e1d25f90da979ab2.html">rov_control</a></li><li class="navelem"><a class="el" href="EKF__sensor__fusion__controller_8hpp.html">EKF_sensor_fusion_controller.hpp</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
