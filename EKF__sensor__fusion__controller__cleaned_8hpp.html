<!-- HTML header for doxygen 1.9.8-->
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=11" />
  <meta name="generator" content="Doxygen 1.9.8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ROV2026: src/rov_control/include/rov_control/EKF_sensor_fusion_controller_cleaned.hpp File Reference</title>
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  <script type="text/javascript" src="darkmode_toggle.js"></script>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript">
    // Force dark mode as default if no preference is set
    if (window.matchMedia && !localStorage.getItem('doxygen-awesome-dark-mode')) {
      if (!window.matchMedia('(prefers-color-scheme: dark)').matches) {
        localStorage.setItem('doxygen-awesome-dark-mode', 'dark');
      }
    }
  </script>
  <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
  <script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
  </script>
</head>
<body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
      <div id="titlearea">
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr id="projectrow">
              <td id="projectalign">
                <div id="projectname">ROV2026
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- end header part --><!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('EKF__sensor__fusion__controller__cleaned_8hpp.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">EKF_sensor_fusion_controller_cleaned.hpp File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Extended Kalman Filter for 6-DOF State Estimation with IMU, Pressure Sensor, and USBL.  
<a href="#details">More...</a></p>

<p><a href="EKF__sensor__fusion__controller__cleaned_8hpp_source.html">Go to the source code of this file.</a></p>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Extended Kalman Filter for 6-DOF State Estimation with IMU, Pressure Sensor, and USBL. </p>
<p>This filter estimates the full 6-DOF state of an underwater vehicle by fusing data from:</p><ul>
<li>A 9-DOF IMU (e.g., BNO055) providing linear acceleration, angular velocity, and orientation (quaternion)</li>
<li>A pressure sensor providing depth (z-position) measurements</li>
<li>A USBL system providing noisy position fixes with distance-dependent measurement uncertainty</li>
</ul>
<p>The filter incorporates underwater-specific models including hydrodynamic drag effects and bias estimation for improved accuracy in challenging marine environments.</p>
<h1><a class="anchor" id="state_vector"></a>
State Definition</h1>
<p>The EKF state vector consists of 19 elements representing the vehicle's complete kinematic state:</p>
<p class="formulaDsp">
\[
\mathbf{x}_k =
\begin{bmatrix}
\mathbf{p}_k \\
\mathbf{v}_k \\
\mathbf{q}_k \\
\mathbf{\omega}_k \\
\mathbf{b}_{\mathbf{\omega}_k} \\
\mathbf{b}_{\mathbf{a}_k}
\end{bmatrix}
\in \mathbb{R}^{19}
\]
</p>
<p>where:</p><ul>
<li>\( \mathbf{p}_k \in \mathbb{R}^3 \): Position in the world frame</li>
<li>\( \mathbf{v}_k \in \mathbb{R}^3 \): Velocity in the world frame</li>
<li>\( \mathbf{q}_k \in \mathbb{R}^4 \): Unit quaternion representing orientation from body to world frame</li>
<li>\( \mathbf{\omega}_k \in \mathbb{R}^3 \): Angular velocity in the body frame</li>
<li>\( \mathbf{b}_{\mathbf{\omega}_k} \in \mathbb{R}^3 \): Gyroscope bias vector</li>
<li>\( \mathbf{b}_{\mathbf{a}_k} \in \mathbb{R}^3 \): Accelerometer bias vector</li>
</ul>
<p>This comprehensive state representation allows the filter to track both translational and rotational motion while simultaneously estimating sensor biases that can drift over time due to environmental factors.</p>
<h1><a class="anchor" id="process_model"></a>
Process Model</h1>
<p>The discrete-time motion model propagates the state over timestep \( \Delta t \) using physics-based equations:</p>
<p class="formulaDsp">
\[
\begin{aligned}
\mathbf{p}_{k+1} &amp;= \mathbf{p}_k + \mathbf{v}_k \Delta t + \frac{1}{2}(\mathbf{R}(\mathbf{q}_k)(\mathbf{a}_k-\mathbf{b}_{\mathbf{a}_k}) - \mathbf{g}) \Delta t^2 \\
\mathbf{v}_{k+1} &amp;= \mathbf{v}_k + (\mathbf{R}(\mathbf{q}_k)(\mathbf{a}_k-\mathbf{b}_{\mathbf{a}_k}) - \mathbf{g}) \Delta t - \mathbf{D}_{\text{linear}}\mathbf{v}_k\Delta t \\
\mathbf{q}_{k+1} &amp;= \mathbf{q}_k \otimes \exp_q\left( \frac{1}{2} (\mathbf{\omega}_k-\mathbf{b}_{\mathbf{\omega}_k}) \Delta t \right) \\
\mathbf{\omega}_{k+1} &amp;= \mathbf{\omega}_k - \mathbf{D}_{\text{angular}}\mathbf{\omega}_k\Delta t + \mathbf{w}_{\mathbf{\omega}} \\
\mathbf{b}_{\mathbf{\omega}_{k+1}} &amp;= \mathbf{b}_{\mathbf{\omega}_k} + \mathbf{w}_b \\
\mathbf{b}_{\mathbf{a}_{k+1}} &amp;= \mathbf{b}_{\mathbf{a}_k} + \mathbf{w}_{ba}
\end{aligned}
\]
</p>
<p>The quaternion update uses the exponential map for numerically stable integration:  </p><p class="formulaDsp">
\[
\delta \mathbf{q}_k = \exp_q\left( \frac{1}{2} \mathbf{\omega}_k \Delta t \right)
= \left[ \cos\left(\frac{\theta}{2}\right),\ \sin\left(\frac{\theta}{2}\right) \frac{\mathbf{\omega}_k}{\theta} \right]
\quad \text{where} \quad \theta = \|\mathbf{\omega}_k\| \Delta t
\]
</p>
<p>Model parameters:</p><ul>
<li>\( \mathbf{a}_k \): IMU-measured linear acceleration (body frame)</li>
<li>\( \mathbf{R}(\mathbf{q}) \): Rotation matrix corresponding to quaternion \( \mathbf{q} \)</li>
<li>\( \mathbf{g} \): World-frame gravity vector \( [0, 0, 9.81]^T \)</li>
<li>\( \otimes \): Quaternion multiplication operator</li>
<li>\( \mathbf{w}_{\mathbf{\omega}}, \mathbf{w}_b, \mathbf{w}_{ba} \): Process noise terms for angular velocity and bias random walks</li>
<li>\( \mathbf{D}_{\text{linear}} = \text{diag}(d_x, d_y, d_z) \): Linear drag coefficient matrix</li>
<li>\( \mathbf{D}_{\text{angular}} = \text{diag}(d_{\text{roll}}, d_{\text{pitch}}, d_{\text{yaw}}) \): Angular drag coefficient matrix</li>
</ul>
<h1><a class="anchor" id="hydrodynamic_model"></a>
Hydrodynamic Effects Model</h1>
<p>The filter incorporates simplified hydrodynamic drag models essential for underwater vehicle dynamics:</p>
<p class="formulaDsp">
\[
\begin{aligned}
\mathbf{F}_{\text{drag}} &amp;= -\mathbf{D}_{\text{linear}}\mathbf{v}_k \\
\mathbf{\tau}_{\text{drag}} &amp;= -\mathbf{D}_{\text{angular}}\mathbf{\omega}_k
\end{aligned}
\]
</p>
<p>where \( \mathbf{F}_{\text{drag}} \) represents drag force in the world frame and \( \mathbf{\tau}_{\text{drag}} \) represents drag torque in the body frame. The diagonal drag matrices \( \mathbf{D}_{\text{linear}} \) and \( \mathbf{D}_{\text{angular}} \) capture first-order hydrodynamic resistance effects.</p>
<p>This modeling is critical for underwater applications because:</p><ul>
<li>Water resistance significantly affects vehicle dynamics compared to aerial vehicles</li>
<li>Drag forces provide natural damping that improves velocity estimation accuracy</li>
<li>Proper drag modeling enhances dead-reckoning performance during USBL outages</li>
<li>The model helps distinguish between thruster-induced and drag-induced accelerations</li>
</ul>
<h1><a class="anchor" id="measurement_models"></a>
Measurement Models</h1>
<p>The filter processes measurements from multiple sensors with distinct characteristics:</p>
<p><b>Pressure Sensor (Depth Measurement):</b>  </p><p class="formulaDsp">
\[
z_k^{\text{depth}} = p_k^{(z)} + v_k^{\text{depth}}
\]
</p>
<p> where \( p_k^{(z)} \) is the z-component of position and \( v_k^{\text{depth}} \sim \mathcal{N}(0, \sigma_{\text{depth}}^2) \). Pressure sensors provide highly accurate depth information with minimal drift, serving as a crucial absolute reference for vertical position estimation.</p>
<p><b>USBL Position Measurement:</b>  </p><p class="formulaDsp">
\[
z_k^{\text{USBL}} = \mathbf{p}_k + \mathbf{v}_k^{\text{USBL}}
\]
</p>
<p> where \( \mathbf{v}_k^{\text{USBL}} \sim \mathcal{N}(0, \mathbf{R}_k^{\text{USBL}}) \) with range-dependent covariance. USBL measurements provide full 3D position but with variable accuracy depending on distance and environmental conditions.</p>
<p><b>IMU Integration:</b> The IMU provides continuous measurements of linear acceleration and angular velocity, which are integrated through the process model. Quaternion measurements from the IMU can optionally be incorporated as direct orientation observations when available.</p>
<h1><a class="anchor" id="measurement_gating"></a>
Measurement Validation Gating</h1>
<p>A chi-square statistical validation gate rejects outlier measurements to improve robustness:</p>
<p class="formulaDsp">
\[
d^2 = \mathbf{y}_k^T \mathbf{S}_k^{-1} \mathbf{y}_k \leq \gamma
\]
</p>
<p>where:</p><ul>
<li>\( \mathbf{y}_k = \mathbf{z}_k - h(\mathbf{x}_{k|k-1}) \) is the innovation (measurement residual)</li>
<li>\( \mathbf{S}_k = \mathbf{H}_k \mathbf{P}_{k|k-1} \mathbf{H}_k^T + \mathbf{R}_k \) is the innovation covariance matrix</li>
<li>\( d^2 \) is the squared Mahalanobis distance</li>
<li>\( \gamma \) is the chi-square threshold corresponding to the desired confidence level and measurement dimension</li>
</ul>
<p>This validation is particularly important for USBL measurements, which can suffer from:</p><ul>
<li>Multipath propagation effects in complex underwater environments</li>
<li>Acoustic interference from other systems or marine life</li>
<li>Signal blockage by obstacles or vehicle structures</li>
<li>Range-dependent degradation in measurement quality</li>
</ul>
<p>Measurements failing the validation test are rejected, allowing the filter to rely on dead-reckoning until valid measurements become available again.</p>
<h1><a class="anchor" id="usbl_covariance"></a>
USBL Range-Dependent Noise Modeling</h1>
<p>USBL systems exhibit measurement uncertainty that increases with range due to their angle-of-arrival sensing principle. The measurement noise covariance matrix models this geometric relationship:</p>
<p class="formulaDsp">
\[
\mathbf{R}_k^{\text{USBL}} = \sigma_\theta^2 r_k^2 (\mathbf{I}_3 - \mathbf{n}\mathbf{n}^T) + \sigma_r^2 \mathbf{n}\mathbf{n}^T
\]
</p>
<p>where:</p><ul>
<li>\( \sigma_\theta^2 \): Angular measurement variance (constant)</li>
<li>\( \sigma_r^2 \): Range measurement variance (constant)</li>
<li>\( r_k = \|\mathbf{p}_k - \mathbf{p}_{\text{USBL}}\| \): Range from USBL transducer to vehicle</li>
<li>\( \mathbf{n} = \frac{\mathbf{p}_k - \mathbf{p}_{\text{USBL}}}{\|\mathbf{p}_k - \mathbf{p}_{\text{USBL}}\|} \): Unit vector along line-of-sight</li>
<li>\( \mathbf{I}_3 - \mathbf{n}\mathbf{n}^T \): Projection onto the tangent plane perpendicular to line-of-sight</li>
</ul>
<p>This formulation captures the geometric nature of USBL uncertainty:</p><ul>
<li>The term \( \sigma_\theta^2 r_k^2 (\mathbf{I}_3 - \mathbf{n}\mathbf{n}^T) \) models angular uncertainty, which increases quadratically with range and acts perpendicular to the line-of-sight</li>
<li>The term \( \sigma_r^2 \mathbf{n}\mathbf{n}^T \) models range uncertainty, which is independent of distance and acts along the line-of-sight direction</li>
</ul>
<p>This results in an ellipsoidal uncertainty region that is elongated perpendicular to the line-of-sight at longer ranges, accurately reflecting the physical limitations of acoustic positioning systems.</p>
<h1><a class="anchor" id="bias_estimation"></a>
Sensor Bias Estimation and Observability</h1>
<p>The filter estimates both gyroscope and accelerometer biases to compensate for systematic sensor errors:</p>
<p class="formulaDsp">
\[
\begin{aligned}
\mathbf{\omega}_{\text{true}} &amp;= \mathbf{\omega}_{\text{measured}} - \mathbf{b}_{\mathbf{\omega}} \\
\mathbf{a}_{\text{true}} &amp;= \mathbf{a}_{\text{measured}} - \mathbf{b}_{\mathbf{a}} \\
\mathbf{b}_{\mathbf{\omega}_{k+1}} &amp;= \mathbf{b}_{\mathbf{\omega}_k} + \mathbf{w}_b \\
\mathbf{b}_{\mathbf{a}_{k+1}} &amp;= \mathbf{b}_{\mathbf{a}_k} + \mathbf{w}_{ba}
\end{aligned}
\]
</p>
<p>where \( \mathbf{w}_b, \mathbf{w}_{ba} \sim \mathcal{N}(0, \mathbf{Q}_b) \) model the biases as random walk processes.</p>
<p>Bias estimation is essential because:</p><ul>
<li>Small systematic errors integrate into large position and orientation drifts over time</li>
<li>Temperature variations and aging affect sensor calibration</li>
<li>Manufacturing tolerances create unit-to-unit variations in sensor characteristics</li>
<li>Proper bias estimation significantly improves long-term navigation accuracy</li>
</ul>
<p><b>Observability Considerations:</b></p><ul>
<li>Gyroscope biases are observable through orientation drift when external attitude references are available</li>
<li>Accelerometer biases are most observable during vehicle maneuvers with varying orientation relative to gravity</li>
<li>The coupling between accelerometer bias and gravity requires sufficient vehicle motion for proper estimation</li>
<li>USBL position fixes provide the external reference needed to observe IMU bias effects</li>
</ul>
<h1><a class="anchor" id="ekf_implementation"></a>
EKF Implementation and Jacobian Computation</h1>
<p>The Extended Kalman Filter linearizes the nonlinear process and measurement models using Jacobian matrices:</p>
<p><b>State Transition Jacobian:</b> \( \mathbf{F}_k = \frac{\partial f(\mathbf{x}_k, \mathbf{u}_k)}{\partial \mathbf{x}_k} \) captures how small changes in the current state propagate to the next time step.</p>
<p><b>Measurement Jacobians:</b></p><ul>
<li>USBL: \( \mathbf{H}_k^{\text{USBL}} = [\mathbf{I}_3,\ \mathbf{0}_{3 \times 16}] \) (direct position observation)</li>
<li>Pressure: \( \mathbf{H}_k^{\text{depth}} = [0\ 0\ 1\ \mathbf{0}_{1 \times 16}] \) (z-position only)</li>
</ul>
<p><b>Quaternion Jacobians:</b> For orientation updates, the left quaternion multiplication matrix is used:  </p><p class="formulaDsp">
\[
\mathbf{L}(\mathbf{q}) =
\begin{bmatrix}
q_w &amp; -q_x &amp; -q_y &amp; -q_z \\
q_x &amp;  q_w &amp; -q_z &amp;  q_y \\
q_y &amp;  q_z &amp;  q_w &amp; -q_x \\
q_z &amp; -q_y &amp;  q_x &amp;  q_w
\end{bmatrix}
\]
</p>
<p>The derivative of body-to-world rotated vectors with respect to quaternion parameters:  </p><p class="formulaDsp">
\[
\frac{\partial (\mathbf{R}(\mathbf{q}) \mathbf{a})}{\partial \mathbf{q}} \in \mathbb{R}^{3 \times 4}
\]
</p>
<p> provides the sensitivity of rotated IMU measurements to orientation changes, enabling proper uncertainty propagation through the nonlinear rotation operations.</p>
<p><b>Update Sequence:</b> During each filter cycle:</p><ol type="1">
<li>Predict state and covariance using the process model</li>
<li>Compute range-dependent USBL measurement covariance \( \mathbf{R}_k^{\text{USBL}} \)</li>
<li>Apply measurement validation gating to incoming sensor data</li>
<li>Update state estimate using validated measurements</li>
<li>Maintain quaternion normalization to prevent numerical drift </li>
</ol>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_4d9e6af0123971837824dfe4e67503a9.html">rov_control</a></li><li class="navelem"><a class="el" href="dir_d529950bd809127c82dd21a158f9c8ee.html">include</a></li><li class="navelem"><a class="el" href="dir_1221e203e50e6cd6e1d25f90da979ab2.html">rov_control</a></li><li class="navelem"><a class="el" href="EKF__sensor__fusion__controller__cleaned_8hpp.html">EKF_sensor_fusion_controller_cleaned.hpp</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
